<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ADRF í•¨ê»˜í•˜ëŠ” ë‚˜ëˆ” ìº í˜ì¸</title>

<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

<style>
  :root{
    --bg:#0f0f12; --card:#14151b; --muted:#9aa1b2;
    --brand:#ff5a66; --brand-2:#ff8a5c; --accent:#6ee7ff; --ring:rgba(255,90,102,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:#eaeef7; background:
      radial-gradient(1200px 600px at 90% -10%, rgba(110,231,255,.08), transparent 60%),
      radial-gradient(800px 500px at -10% 10%, rgba(255,138,92,.08), transparent 60%),
      var(--bg);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:28px}

  /* NAV */
  .nav{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
  .brand i{color:var(--brand)}
  .badge{font-size:.78rem;background:#eaf7ff;color:#0b3340;padding:6px 10px;border-radius:999px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg,#1a1c23,#14151b);
    color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;font-weight:700
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));border:none;box-shadow:0 6px 24px rgba(255,90,102,.35)}

  /* HERO */
  .hero{
    position:relative;overflow:hidden;border-radius:20px;padding:42px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 30px 80px rgba(0,0,0,.35), inset 0 0 120px rgba(255,255,255,.04);
    backdrop-filter: blur(8px);
  }
  .hero h1{font-size:clamp(28px,5vw,44px);margin:0 0 10px;font-weight:800;line-height:1.15}
  .hero p{margin:0;color:var(--muted);font-size:clamp(14px,2.2vw,18px)}
  .hero-cta{display:flex;gap:12px;margin-top:22px;flex-wrap:wrap}

  .progress{margin-top:22px;background:#0e1016;border:1px solid rgba(255,255,255,.08);height:14px;border-radius:999px;overflow:hidden}
  .progress>span{
    display:block;height:100%;width:0%;
    background:linear-gradient(90deg,var(--accent),#a7f3d0);
    box-shadow:0 4px 16px rgba(110,231,255,.35) inset;
    transition:width .4s ease;
  }

  .stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:18px}
  .stat{background:#0e1016;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px 16px;text-align:center}
  .stat b{display:block;font-size:1.15rem}
  .stat small{color:var(--muted)}

  /* SECTION */
  .section{margin-top:42px}
  .section h2{margin:0 0 16px;font-size:1.6rem}

  /* GALLERY */
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
  .card{overflow:hidden;border-radius:18px;background:#0e1016;border:1px solid rgba(255,255,255,.08);position:relative}
  .card img{width:100%;height:320px;object-fit:cover;display:block}
  .tag{
    position:absolute;left:12px;top:12px;background:rgba(0,0,0,.55);
    color:#fff;padding:6px 10px;border-radius:999px;font-weight:700;border:1px solid rgba(255,255,255,.16)
  }
  .caption{padding:12px 14px;color:#cbd5e1;font-size:.95rem}

  /* DONOR LIST (í™ˆ ì„¹ì…˜) */
  .donor-list{margin-top:40px;background:#0e1016;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:20px}
  .donor-list h3{margin:0 0 14px;font-size:1.2rem}
  .donor-list ul{list-style:none;padding:0;margin:0}
  .donor-list li{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06)}
  .donor-list li:last-child{border-bottom:none}

  /* MODAL */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:50;padding:16px}
  .modal{width:min(560px,96vw);background:#0f1117;border:1px solid rgba(255,255,255,.1);border-radius:18px;padding:24px;box-shadow:0 30px 100px rgba(0,0,0,.5)}
  .modal h3{margin:0 0 10px}
  .form{display:grid;gap:12px;margin-top:6px}
  label{font-weight:700}
  input[type="text"], input[type="number"]{
    width:100%;padding:14px 16px;border-radius:12px;background:#0b0d12;color:#e7ecf8;border:1.5px solid rgba(255,255,255,.14);outline:0;transition:.18s
  }
  input:focus{border-color:var(--ring);box-shadow:0 0 0 6px rgba(255,90,102,.12)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .x{background:transparent;border:1px solid rgba(255,255,255,.2);padding:10px 14px;border-radius:12px;color:#fff;cursor:pointer}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  .bank{margin-top:10px;background:#0b0d12;border:1px dashed rgba(255,255,255,.18);padding:14px;border-radius:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b0d12;border:1px solid rgba(255,255,255,.14);font-size:.9rem;color:#cfe7ff}
  .muted{color:#9aa1b2}
  .sep{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

  /* ===== Donors ì „ìš© í˜ì´ì§€ ===== */
  .page{display:none}
  .page.active{display:block}
  .page-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:16px}
  .donors-table{width:100%;border-collapse:collapse;background:#0e1016;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  .donors-table th, .donors-table td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
  .donors-table th{background:#0b0d12}
  .empty{padding:20px;color:var(--muted);text-align:center}

  @media (max-width:860px){
    .grid{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<a class="skip" href="#donate" style="position:absolute;left:-9999px;">ë°”ë¡œ ê¸°ë¶€ í¼ìœ¼ë¡œ ì´ë™</a>

<header class="wrap nav" aria-label="ìƒë‹¨ íƒìƒ‰">
  <div class="brand">
    <i class="fa-solid fa-hand-holding-heart"></i>
    <span>ADRF ë‚˜ëˆ” ìº í˜ì¸</span>
    <span class="badge" aria-label="íˆ¬ëª…ì„± ë°°ì§€"><i class="fa-solid fa-shield-halved"></i> íˆ¬ëª… ê³µê°œ</span>
  </div>
  <div class="actions">
    <a href="#impact" class="btn">ì„íŒ©íŠ¸</a>
    <a href="#gallery" class="btn">ì§€ì› êµ­ê°€</a>
    <a href="#donors" class="btn" id="openDonors">ëª…ë‹¨</a>
    <button class="btn primary" id="openDonate">ê¸°ë¶€í•˜ê¸°</button>
  </div>
</header>

<!-- ìŠ¤í‚µ ë§í¬ ëª©ì ì§€ -->
<div id="donate" class="wrap" style="position:relative;height:1px;overflow:hidden"></div>

<!-- ====== HOME PAGE ====== -->
<main class="wrap page active" id="pageHome" aria-label="í™ˆ í˜ì´ì§€">
  <section class="hero" aria-labelledby="heroTitle">
    <h1 id="heroTitle">ì—¬ëŸ¬ë¶„ì˜ ì˜¤ëŠ˜ì´,<br/>ëˆ„êµ°ê°€ì˜ ë‚´ì¼ì„ ë¹„ì¶¥ë‹ˆë‹¤.</h1>
    <p>ì—¬ëŸ¬ë¶„ì˜ í›„ì›ì€ ì¸ë„ë„¤ì‹œì•„ì™€ ëª½ê³¨ì˜ ì•„ì´ë“¤ì—ê²Œ ë” ë§ì€ ì±…ê³¼ ë°°ì›€ì˜ ê¸°íšŒë¥¼ ì „í•©ë‹ˆë‹¤.</p>

    <div class="hero-cta">
      <button class="btn primary" id="openDonate2"><i class="fa-solid fa-heart"></i> ì§€ê¸ˆ ê¸°ë¶€í•˜ê¸°</button>
    </div>

    <div class="progress" aria-label="ëª¨ê¸ˆ ì§„í–‰ë¥ " role="progressbar" aria-valuemin="0" aria-valuemax="100">
      <span id="progressBar"></span>
    </div>
    <div class="stats" id="impact">
      <div class="stat"><b id="raised">0ì›</b><small>í˜„ì¬ ëª¨ê¸ˆì•¡</small></div>
      <div class="stat"><b>2ê°œêµ­</b><small>ì¸ë„ë„¤ì‹œì•„ Â· ëª½ê³¨</small></div>
    </div>
  </section>

  <!-- ì§€ì› êµ­ê°€ ì„¹ì…˜ -->
  <section class="section" id="gallery" aria-labelledby="gTitle">
    <h2 id="gTitle">ì§€ì› êµ­ê°€ (ì¸ë„ë„¤ì‹œì•„, ëª½ê³¨)</h2>
    <div class="grid">
      <figure class="card">
        <img src="https://i.ibb.co/k6QDhD5S/image.jpg" alt="ì¸ë„ë„¤ì‹œì•„ì—ì„œ ì±…ì„ ì½ëŠ” ì•„ì´" />
        <span class="tag">ì¸ë„ë„¤ì‹œì•„</span>
        <figcaption class="caption">ì±… ì†ì—ì„œ ë§Œë‚œ ì„¸ìƒì€, ì•„ì´ë“¤ì˜ ê¿ˆì„ ìë¼ê²Œ í•©ë‹ˆë‹¤.</figcaption>
      </figure>
      <figure class="card">
        <img src="https://i.ibb.co/Lhdv4FcW/image.jpg" alt="ëª½ê³¨ì—ì„œ í™œë™í•˜ë©° ì›ƒê³  ìˆëŠ” ì•„ì´ë“¤" />
        <span class="tag">ëª½ê³¨</span>
        <figcaption class="caption">ì›ƒìŒê³¼ ë°°ì›€ì´ í•¨ê»˜í•˜ëŠ” ìˆœê°„, ë¯¸ë˜ê°€ ìëë‹ˆë‹¤.</figcaption>
      </figure>
    </div>
  </section>

  <!-- ê¸°ë¶€ì ëª…ë‹¨(í™ˆì— ê°„ë‹¨ ë²„ì „) -->
  <section class="donor-list" aria-labelledby="donorTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h3 id="donorTitle">ê¸°ë¶€ì ëª…ë‹¨ (ìµœê·¼ìˆœ)</h3>
      <a href="#donors" class="btn" aria-label="ì „ì²´ ëª…ë‹¨ ë³´ê¸°">ì „ì²´ ë³´ê¸°</a>
    </div>
    <ul id="donorList"></ul>
  </section>

  <!-- ë¬¸ì˜ -->
  <section class="contact" style="margin-top:24px">
    <h3>ë¬¸ì˜</h3>
    <p>ğŸ“§ ì´ë©”ì¼: <a href="mailto:yeojin071115@naver.com">yeojin071115@naver.com</a></p>
    <p>ğŸ“· ì¸ìŠ¤íƒ€ê·¸ë¨: <a href="https://instagram.com/duwls._hy" target="_blank" rel="noopener noreferrer">@duwls._hy</a></p>
  </section>
</main>

<!-- ====== DONORS PAGE ====== -->
<section class="wrap page" id="pageDonors" aria-label="ê¸°ë¶€ì ëª…ë‹¨ í˜ì´ì§€">
  <div class="page-head">
    <h2 style="margin:0">ê¸°ë¶€ì ëª…ë‹¨</h2>
    <div class="actions">
      <a class="btn" href="#"><i class="fa-solid fa-house"></i> í™ˆìœ¼ë¡œ</a>
      <button class="btn primary" id="openDonate3">ê¸°ë¶€í•˜ê¸°</button>
    </div>
  </div>

  <div id="donorsSummary" style="margin:10px 0 16px;color:var(--muted)"></div>

  <div style="overflow-x:auto;border-radius:12px">
    <table class="donors-table" aria-describedby="donorsSummary">
      <thead>
        <tr>
          <th scope="col">ì´ë¦„</th>
          <th scope="col">ê¸ˆì•¡</th>
          <th scope="col">í•œë§ˆë””</th>
          <th scope="col">ì¼ì‹œ</th>
        </tr>
      </thead>
      <tbody id="donorsTableBody">
        <tr><td colspan="4" class="empty">ì•„ì§ ê¸°ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- 2-STEP MODAL -->
<div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="modalTitle">ê¸°ë¶€í•˜ê¸°</h3>
      <button class="x" id="close">ë‹«ê¸°</button>
    </div>

    <!-- STEP 1 -->
    <section id="stepForm" aria-label="ê¸°ë¶€ ì •ë³´ ì…ë ¥">
      <p class="muted" style="margin-top:0">ì´ë¦„, ê¸ˆì•¡, í•œë§ˆë””ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
      <form id="donationForm" class="form" novalidate>
        <div class="row">
          <div>
            <label for="name">ì´ë¦„</label>
            <input id="name" name="name" type="text" placeholder="ì´ë¦„" required autocomplete="off" />
          </div>
          <div>
            <label for="amount">ê¸ˆì•¡(ì›)</label>
            <input id="amount" name="amount" type="number" min="1000" step="100" inputmode="numeric" placeholder="ì˜ˆ: 10000" required />
          </div>
        </div>
        <div>
          <label for="message">í•œë§ˆë””(ì„ íƒ)</label>
          <input id="message" name="message" type="text" placeholder="ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”" />
        </div>
        <div class="btns">
          <button type="submit" class="btn primary" aria-label="ë‹¤ìŒ ë‹¨ê³„ë¡œ">ë‹¤ìŒìœ¼ë¡œ</button>
          <button type="button" class="btn" id="cancel1">ì·¨ì†Œ</button>
        </div>
      </form>
    </section>

    <!-- STEP 2 -->
    <section id="stepConfirm" aria-label="ì†¡ê¸ˆ ì•ˆë‚´" style="display:none">
      <div class="pill"><i class="fa-solid fa-circle-check"></i> ì •ë³´ í™•ì¸ ì™„ë£Œ</div>
      <div class="sep"></div>
      <div class="bank" aria-live="polite"></div>
      <p class="muted" style="margin-top:12px">ì…ê¸ˆì´ í™•ì¸ë˜ë©´ ëª…ë‹¨ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. ë¬¸ì œê°€ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</p>
      <div style="margin-top:14px; padding:12px; background:#0b0d12; border-radius:10px; border:1px solid rgba(255,255,255,.14); font-size:0.9rem;">
        <p style="margin:0 0 6px;"><strong>ğŸ“® ë¬¸ì˜í•˜ê¸°</strong></p>
        <p style="margin:4px 0;"><i class="fa-solid fa-envelope"></i> <a href="mailto:yeojin071115@naver.com">yeojin071115@naver.com</a></p>
        <p style="margin:4px 0;"><i class="fa-brands fa-instagram"></i> <a href="https://instagram.com/duwls._hy" target="_blank" rel="noopener noreferrer">@duwls._hy</a></p>
      </div>
      <div class="btns" style="margin-top:10px">
        <a class="btn" href="#donors" id="goDonorsAfterPay">ëª…ë‹¨ ë³´ê¸°</a>
        <button class="btn" id="close2">ë‹«ê¸°</button>
      </div>
    </section>
  </div>
</div>

<script>
/* =========================
   ì„¤ì •
========================= */
// ëª©í‘œ ëª¨ê¸ˆì•¡(ê²Œì´ì§€ 100%)
const GOAL_AMOUNT = 524000;

// ì‹œê°„ì— ë”°ë¼ ì˜¤ë¥´ëŠ” "ê¸°ë³¸ ì§„í–‰ë¶„" ì„¤ì • (ê¸°ê°„ ë‚´ ì„ í˜• ì¦ê°€)
const START_ISO = "2025-08-10T00:00:00+09:00";
const END_ISO   = "2025-09-10T23:59:59+09:00";
// ê¸°ê°„ì´ ëë‚˜ë©´ ê¸°ë³¸ ì§„í–‰ë¶„ì´ ë„ë‹¬í•  ìµœëŒ€ì¹˜(= ëª©í‘œì•¡ê³¼ ë™ì¼í•˜ê²Œ ë‘ëŠ” ê±¸ ê¶Œì¥)
const TIME_GROWTH_TARGET = 524000;

// ì˜¤í”„ë¼ì¸ ì‹œì‘ ê¸ˆì•¡(í˜„ì¥ ëª¨ê¸ˆ ë“± ìˆìœ¼ë©´ ìˆ«ì ì…ë ¥)
const BASELINE = 0;

// ì—¬ëŸ¬ ì‚¬ëŒì´ í•¨ê»˜ ë³´ê²Œ í•  ë•Œ: Google Apps Script ì›¹ì•± URL (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
const API_URL  = ''; // ì˜ˆ) 'https://script.google.com/macros/s/AK.../exec'
const hasCloud = /^https?:\/\//.test(API_URL);

// rAFë¡œ ë¶€ë“œëŸ½ê²Œ ë Œë”ë§
let rafId = null;

/* =========================
   ê³µí†µ ìœ í‹¸
========================= */
function escapeHTML(str){ return String(str||'').replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fmtKRW(n){ return Number(n||0).toLocaleString('ko-KR') + 'ì›'; }
function fmtDate(ts){
  const d=new Date(ts); const z=(n)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
}
function clamp(v,min,max){ return Math.min(Math.max(v,min),max); }
function setRaised(total){
  const raisedEl = document.getElementById('raised');
  const progressBar = document.getElementById('progressBar');
  const pct = clamp((total / GOAL_AMOUNT) * 100, 0, 100);
  if(raisedEl)  raisedEl.textContent = fmtKRW(total);
  if(progressBar){
    progressBar.style.width = pct + '%';
    progressBar.setAttribute('aria-valuenow', Math.round(pct));
  }
}

/* =========================
   ì‹œê°„ ê¸°ë°˜ ê¸°ë³¸ ì§„í–‰ë¶„ (ì„ í˜• ì¦ê°€)
========================= */
const startDate = new Date(START_ISO);
const endDate   = new Date(END_ISO);
const durationMs = Math.max(endDate - startDate, 1);
function baselineByTime(now = new Date()){
  const elapsed = clamp(now - startDate, 0, durationMs);
  const ratio = elapsed / durationMs; // 0~1
  return Math.round(TIME_GROWTH_TARGET * ratio);
}

/* =========================
   ë°ì´í„°: ë¡œì»¬/í´ë¼ìš°ë“œ
========================= */
// ë¡œì»¬
const STORAGE_KEY='adrf_donors_v1';
function localList(){
  try{ const a=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); return Array.isArray(a)?a:[]; }catch{return []}
}
function localAdd(entry){
  const arr = localList();
  arr.unshift(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  return entry;
}
function localTotal(){ return localList().reduce((s,d)=> s + (Number(d.amount)||0), 0); }

// í´ë¼ìš°ë“œ(GAS)
async function cloudList(){
  const r = await fetch(API_URL, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error('LIST_FAILED');
  return j; // { donors, total, count }
}
async function cloudAdd(entry){
  const r = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(entry)
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'ADD_FAILED');
  return j.donor; // {name,amount,message,ts}
}

/* -------------------------
   í•©ê³„ ê³„ì‚° ë¡œì§
   total(now) = BASELINE + baselineByTime(now) + donationsSum
------------------------- */
let donationsSum = 0; // ê¸°ë¶€ í•©ê³„(ë¡œì»¬ or í´ë¼ìš°ë“œ)
async function refreshDonationsSum(){
  if(hasCloud){
    try{ const { total } = await cloudList(); donationsSum = Number(total)||0; }
    catch{ /* ì‹¤íŒ¨ì‹œ ìœ ì§€ */ }
  }else{
    donationsSum = localTotal();
  }
}
async function getDisplayedTotal(){
  // ì‹œê°„ì— ë”°ë¥¸ ê¸°ë³¸ ì§„í–‰ë¶„ + (ì˜¤í”„ë¼ì¸ ì‹œì‘ê¸ˆ + ê¸°ë¶€ëˆ„ì )
  const timeBase = baselineByTime(new Date());
  const total = BASELINE + timeBase + donationsSum;
  // ê²Œì´ì§€ëŠ” ëª©í‘œ ëŒ€ë¹„ 100%ì—ì„œ ë©ˆì¶”ê²Œ(ë„˜ê²¨ë„ ë˜ë©´ clamp ì œê±°)
  return clamp(total, 0, GOAL_AMOUNT);
}

/* =========================
   UI ë Œë”ëŸ¬
========================= */
async function renderRaisedLoop(){
  // ë§¤ í”„ë ˆì„ ì‹œê°„ê¸°ë°˜ ì§„í–‰ë¶„ì„ ë‹¤ì‹œ ê³„ì‚°(ë¶€ë“œëŸ¬ìš´ ì¦ê°€)
  const total = await getDisplayedTotal();
  setRaised(total);
  rafId = requestAnimationFrame(renderRaisedLoop);
}

/* =========================
   ë¼ìš°íŒ…(í™ˆ <-> ëª…ë‹¨)
========================= */
(function(){
  const pageHome   = document.getElementById('pageHome');
  const pageDonors = document.getElementById('pageDonors');
  function show(page){
    pageHome?.classList.toggle('active', page==='home');
    pageDonors?.classList.toggle('active', page==='donors');
    window.scrollTo({top:0, behavior:'instant'});
  }
  async function route(){
    if(location.hash==='#donors'){ show('donors'); await renderDonorsTable(); await updateDonorsSummary(); }
    else{ show('home'); }
  }
  window.addEventListener('hashchange', route);
  document.addEventListener('DOMContentLoaded', route);
})();

/* =========================
   í™ˆ ì„¹ì…˜: ìµœê·¼ ëª…ë‹¨
========================= */
async function getDonors(){
  if(hasCloud){
    try{ return (await cloudList()).donors; }catch{ return []; }
  }
  return localList();
}
async function renderDonorList(limit=10){
  const donorList = document.getElementById('donorList');
  if(!donorList) return;
  donorList.innerHTML = '<li class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>';
  try{
    const donors = await getDonors();
    donorList.innerHTML='';
    if(donors.length===0){
      donorList.innerHTML = '<li class="muted">ì•„ì§ ê¸°ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      return;
    }
    donors.slice(0,limit).forEach(d=>{
      const li=document.createElement('li');
      li.innerHTML = `<strong>${escapeHTML(d.name)}</strong> â€” ${Number(d.amount).toLocaleString()}ì›` +
                     (d.message? ` <em>(${escapeHTML(d.message)})</em>`:'');
      donorList.appendChild(li);
    });
  }catch{
    donorList.innerHTML = '<li class="muted">ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
  }
}
document.addEventListener('DOMContentLoaded', renderDonorList);

/* =========================
   Donors í˜ì´ì§€: ì „ì²´ í…Œì´ë¸”/ìš”ì•½
========================= */
async function renderDonorsTable(){
  const tbody=document.getElementById('donorsTableBody');
  if(!tbody) return;
  tbody.innerHTML = `<tr><td colspan="4" class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>`;
  try{
    const donors = await getDonors();
    if(donors.length===0){
      tbody.innerHTML = `<tr><td colspan="4" class="empty">ì•„ì§ ê¸°ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }
    tbody.innerHTML='';
    donors.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${escapeHTML(d.name)}</strong></td>
        <td>${Number(d.amount).toLocaleString()}ì›</td>
        <td>${d.message ? escapeHTML(d.message) : '<span class="muted">â€”</span>'}</td>
        <td class="muted">${fmtDate(d.ts)}</td>
      `;
      tbody.appendChild(tr);
    });
  }catch{
    tbody.innerHTML = `<tr><td colspan="4" class="empty">ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
  }
}
async function updateDonorsSummary(){
  const box=document.getElementById('donorsSummary');
  if(!box) return;
  box.textContent='ì§‘ê³„ ì¤‘â€¦';
  try{
    const donors = await getDonors();
    const total  = await getDisplayedTotal();
    box.textContent = `ì´ ${donors.length.toLocaleString()}ê±´ Â· ëˆ„ì  ${fmtKRW(total)}`;
  }catch{
    box.textContent = 'ìš”ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
  }
}

/* =========================
   ëª¨ë‹¬ & í¼ ì œì¶œ
========================= */
document.addEventListener('DOMContentLoaded', async () => {
  const overlay = document.getElementById('overlay');
  const openDonate  = document.getElementById('openDonate');
  const openDonate2 = document.getElementById('openDonate2');
  const openDonate3 = document.getElementById('openDonate3');
  const closeBtn  = document.getElementById('close');
  const closeBtn2 = document.getElementById('close2');
  const cancel1   = document.getElementById('cancel1');
  const stepForm    = document.getElementById('stepForm');
  const stepConfirm = document.getElementById('stepConfirm');
  const donationForm = document.getElementById('donationForm');
  const nameInput   = document.getElementById('name');
  const amountInput = document.getElementById('amount');

  let lastFocused;

  function openModal(){
    lastFocused = document.activeElement;
    overlay.style.display='grid';
    stepForm.style.display='block';
    stepConfirm.style.display='none';
    donationForm.reset();
    setTimeout(()=>nameInput?.focus(),0);
  }
  function closeModal(){
    overlay.style.display='none';
    lastFocused && typeof lastFocused.focus==='function' && lastFocused.focus();
  }

  openDonate?.addEventListener('click', openModal);
  openDonate2?.addEventListener('click', openModal);
  openDonate3?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  closeBtn2?.addEventListener('click', closeModal);
  cancel1?.addEventListener('click', closeModal);

  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && overlay.style.display==='grid') closeModal(); });
  overlay.addEventListener('click',(e)=>{ if(e.target===overlay) closeModal(); });

  // 1) ê¸°ë¶€ í•©ê³„ ì´ˆê¸° ë¡œë“œ, 2) ê²Œì´ì§€ ë Œë”ë§ ë£¨í”„ ì‹œì‘
  await refreshDonationsSum();
  renderRaisedLoop();

  // (í´ë¼ìš°ë“œì¼ ë•Œ) 20ì´ˆë§ˆë‹¤ í•©ê³„/ëª…ë‹¨ ìƒˆë¡œê³ ì¹¨
  if(hasCloud){
    setInterval(async () => {
      await refreshDonationsSum();
      renderDonorList();
      if(location.hash==='#donors'){
        renderDonorsTable();
        updateDonorsSummary();
      }
    }, 20000);
  }

  // ì œì¶œ â†’ ì €ì¥ â†’ í•©ê³„ ì¦‰ì‹œ ê°±ì‹ (ì í”„) â†’ í™•ì¸ ë‹¨ê³„ â†’ ëª…ë‹¨ í˜ì´ì§€ë¡œ ì´ë™
  donationForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = donationForm.name.value.trim();
    const amount = parseInt(donationForm.amount.value, 10);
    const message = donationForm.message.value.trim();

    if(!name){ nameInput.focus(); return; }
    if(!Number.isFinite(amount) || amount<1000){ amountInput.focus(); return; }

    try{
      // ì €ì¥
      let saved;
      if(hasCloud){
        saved = await cloudAdd({name, amount, message});
        await refreshDonationsSum(); // ì„œë²„ ë°˜ì˜ ì¦‰ì‹œ í•©ê³„ ê°±ì‹ 
      }else{
        saved = localAdd({name, amount, message, ts: Date.now()});
        donationsSum += amount; // ë¡œì»¬ì€ ì¦‰ì‹œ ë”í•˜ê¸°
      }

      // í™ˆ ë¦¬ìŠ¤íŠ¸/ìš”ì•½ ê°±ì‹ (ë³´ì´ëŠ” í™”ë©´ ì¦‰ì‹œ ë°˜ì˜)
      renderDonorList();
      if(location.hash==='#donors'){
        renderDonorsTable();
        updateDonorsSummary();
      }

      // í™•ì¸ ë‹¨ê³„ë¡œ ì „í™˜
      stepForm.style.display='none';
      stepConfirm.style.display='block';

      // ì†¡ê¸ˆ ì•ˆë‚´
      const bankBox = stepConfirm.querySelector('.bank');
      bankBox.innerHTML = `
        <p><strong>ì†¡ê¸ˆ ê³„ì¢Œ</strong></p>
        <p>ì€í–‰ëª…: ê¸°ì—…ì€í–‰</p>
        <p>ê³„ì¢Œë²ˆí˜¸: 000-5032-4897</p>
        <p>ì˜ˆê¸ˆì£¼: ì¡°ìˆœì˜¥</p>
        <p class="muted">ì…ê¸ˆìëª…ì€ <strong>${escapeHTML(saved.name||name)}</strong>(ìœ¼)ë¡œ ì†¡ê¸ˆí•´ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤.</p>
      `;

      // ëª…ë‹¨ í˜ì´ì§€ë¡œ ìë™ ì´ë™
      setTimeout(()=>{ closeModal(); location.hash='#donors'; }, 400);

    }catch(err){
      alert('ì €ì¥ì´ ì‹¤íŒ¨í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    }
  });
});
</script>
</body>
</html>

